# CRUD операции для приложения Books

**Тема #22. CRUD и агрегатные операции**

## Описание

Реализованы полные CRUD операции для всех моделей приложения `books`:
- **Book** (Книги)
- **Publisher** (Издательства)
- **Store** (Магазины)
- **Review** (Отзывы)

## Структура

### Файлы

- `books/forms.py` - формы для всех моделей
- `books/views.py` - представления с CRUD операциями
- `books/urls.py` - маршруты для всех операций
- `templates/books/` - шаблоны для всех страниц
- `static/books/css/styles.css` - стили для приложения

### URL маршруты

Все маршруты доступны по префиксу `/books/`:

#### Книги (Book)
- `/books/` - список книг
- `/books/book/<id>/` - детальная информация о книге
- `/books/book/create/` - создание новой книги
- `/books/book/<id>/update/` - редактирование книги
- `/books/book/<id>/delete/` - удаление книги

#### Издательства (Publisher)
- `/books/publishers/` - список издательств
- `/books/publisher/<id>/` - детальная информация об издательстве
- `/books/publisher/create/` - создание нового издательства
- `/books/publisher/<id>/update/` - редактирование издательства
- `/books/publisher/<id>/delete/` - удаление издательства

#### Магазины (Store)
- `/books/stores/` - список магазинов
- `/books/store/<id>/` - детальная информация о магазине
- `/books/store/create/` - создание нового магазина
- `/books/store/<id>/update/` - редактирование магазина
- `/books/store/<id>/delete/` - удаление магазина

#### Отзывы (Review)
- `/books/reviews/` - список отзывов
- `/books/review/<id>/` - детальная информация об отзыве
- `/books/review/create/` - создание нового отзыва
- `/books/review/<id>/update/` - редактирование отзыва
- `/books/review/<id>/delete/` - удаление отзыва

#### Аналитика
- `/books/analytics/` - страница с агрегатными данными

## Функциональность

### CRUD операции

Для каждой модели реализованы:
- **Create** - создание новой записи через форму
- **Read** - просмотр списка и детальной информации
- **Update** - редактирование существующей записи
- **Delete** - удаление с подтверждением

### Фильтрация и сортировка

**Книги:**
- Фильтрация по издательству
- Фильтрация по году публикации
- Поиск по названию или автору
- Сортировка по названию, автору, дате публикации

**Издательства:**
- Поиск по названию или стране

**Магазины:**
- Фильтрация по городу
- Поиск по названию

**Отзывы:**
- Фильтрация по оценке
- Фильтрация по книге

### Агрегатные функции

Страница аналитики (`/books/analytics/`) показывает:
- Общее количество книг и отзывов
- Среднюю оценку всех книг
- Статистику по издательствам (количество книг, средняя оценка)
- Статистику по магазинам (количество книг)
- Топ книги по рейтингу (минимум 3 отзыва)
- Книги с наибольшим количеством отзывов
- Статистику по годам публикации

## Использование Django ORM

### Агрегатные функции

Используются следующие методы Django ORM:

1. **Count** - подсчет количества записей
   ```python
   Publisher.objects.annotate(books_count=Count('books'))
   ```

2. **Avg** - вычисление средней оценки
   ```python
   Review.objects.aggregate(Avg('rating'))
   ```

3. **annotate** - добавление вычисляемых полей
   ```python
   Book.objects.annotate(
       avg_rating=Avg('reviews__rating'),
       reviews_count=Count('reviews')
   )
   ```

4. **select_related** - оптимизация запросов для ForeignKey
   ```python
   Book.objects.select_related('publisher')
   ```

5. **prefetch_related** - оптимизация запросов для ManyToMany и обратных связей
   ```python
   Book.objects.prefetch_related('stores', 'reviews')
   ```

### Оптимизация запросов

Все представления используют оптимизацию запросов:
- `select_related()` для ForeignKey связей
- `prefetch_related()` для ManyToMany и обратных связей
- `annotate()` для вычисляемых полей без дополнительных запросов

## Запуск

1. Убедитесь, что сервер запущен:
   ```bash
   python manage.py runserver
   ```

2. Откройте в браузере:
   - Список книг: http://127.0.0.1:8000/books/
   - Аналитика: http://127.0.0.1:8000/books/analytics/

## Тестирование

Для тестирования CRUD операций:

1. Создайте тестовые данные через админ-панель или через формы
2. Проверьте создание записей через формы
3. Проверьте редактирование записей
4. Проверьте удаление с подтверждением
5. Проверьте фильтрацию и сортировку
6. Проверьте страницу аналитики

## Примечания

- Все формы валидируются на стороне сервера
- Перед удалением показывается страница подтверждения
- Используется пагинация для больших списков (10-15 записей на странице)
- Все запросы оптимизированы для минимизации количества обращений к БД

