{% extends 'books/base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<h1 class="page-title">{{ page_title }}</h1>

<div class="actions">
    <a href="{% url 'books:book_create' %}" class="btn btn-primary">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É</a>
    <a href="{% url 'books:analytics' %}" class="btn btn-secondary">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
<div class="filters">
    <h3>–§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫</h3>
    
    <form method="get" class="search-form">
        <input type="text" name="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∞–≤—Ç–æ—Ä—É..." 
               value="{{ current_search }}" class="form-control">
        <button type="submit" class="btn btn-primary">üîç –ù–∞–π—Ç–∏</button>
        {% if current_search %}
            <a href="{% url 'books:book_list' %}" class="btn btn-secondary">‚úñÔ∏è –°–±—Ä–æ—Å–∏—Ç—å</a>
        {% endif %}
    </form>
    
    <form method="get" style="margin-top: 1rem;">
        <div class="filter-group">
            <label>–ò–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ:</label>
            <select name="publisher" class="form-control" onchange="this.form.submit()">
                <option value="">–í—Å–µ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞</option>
                {% for publisher in publishers %}
                    <option value="{{ publisher.id }}" {% if current_publisher == publisher.id|stringformat:"s" %}selected{% endif %}>
                        {{ publisher.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-group">
            <label>–ì–æ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:</label>
            <input type="number" name="year" placeholder="–ì–æ–¥" value="{{ current_year }}" 
                   class="form-control" style="width: 120px;" onchange="this.form.submit()">
        </div>
        
        <div class="filter-group">
            <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
            <select name="sort" class="form-control" onchange="this.form.submit()">
                <option value="-published_date" {% if current_sort == '-published_date' %}selected{% endif %}>–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (–Ω–æ–≤—ã–µ)</option>
                <option value="published_date" {% if current_sort == 'published_date' %}selected{% endif %}>–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (—Å—Ç–∞—Ä—ã–µ)</option>
                <option value="title" {% if current_sort == 'title' %}selected{% endif %}>–ù–∞–∑–≤–∞–Ω–∏–µ (–ê-–Ø)</option>
                <option value="-title" {% if current_sort == '-title' %}selected{% endif %}>–ù–∞–∑–≤–∞–Ω–∏–µ (–Ø-–ê)</option>
                <option value="author" {% if current_sort == 'author' %}selected{% endif %}>–ê–≤—Ç–æ—Ä (–ê-–Ø)</option>
                <option value="-author" {% if current_sort == '-author' %}selected{% endif %}>–ê–≤—Ç–æ—Ä (–Ø-–ê)</option>
            </select>
        </div>
        
        {% if current_publisher or current_year %}
            <a href="{% url 'books:book_list' %}" class="btn btn-secondary" style="margin-top: 1.5rem;">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</a>
        {% endif %}
    </form>
</div>

<!-- –°–ø–∏—Å–æ–∫ –∫–Ω–∏–≥ -->
{% if books %}
    <p style="margin-bottom: 1rem; color: #6c757d;">
        –ù–∞–π–¥–µ–Ω–æ –∫–Ω–∏–≥: {{ books.paginator.count }}
    </p>
    
    <div class="list-group">
        {% for book in books %}
            <div class="list-group-item">
                <div>
                    <h3 style="margin-bottom: 0.5rem;">
                        <a href="{% url 'books:book_detail' book.pk %}">{{ book.title }}</a>
                    </h3>
                    <p style="color: #6c757d; margin-bottom: 0.25rem;">
                        <strong>–ê–≤—Ç–æ—Ä:</strong> {{ book.author }}
                    </p>
                    <p style="color: #6c757d; margin-bottom: 0.25rem;">
                        <strong>–ò–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ:</strong> {{ book.publisher.name }}
                    </p>
                    <p style="color: #6c757d; margin-bottom: 0.25rem;">
                        <strong>–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:</strong> {{ book.published_date|date:"d.m.Y" }}
                    </p>
                    {% if book.reviews.count > 0 %}
                        {% with avg_rating=book.reviews.all|length %}
                            {% with rating_sum=book.reviews.all|length %}
                                {% for review in book.reviews.all %}
                                    {% if forloop.first %}
                                        <p style="color: #6c757d;">
                                            <strong>–û—Ç–∑—ã–≤–æ–≤:</strong> {{ book.reviews.count }}
                                        </p>
                                    {% endif %}
                                {% endfor %}
                            {% endwith %}
                        {% endwith %}
                    {% endif %}
                </div>
                <div class="actions">
                    <a href="{% url 'books:book_detail' book.pk %}" class="btn btn-primary btn-sm">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä</a>
                    <a href="{% url 'books:book_update' book.pk %}" class="btn btn-success btn-sm">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                    <a href="{% url 'books:book_delete' book.pk %}" class="btn btn-danger btn-sm">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</a>
                </div>
            </div>
        {% endfor %}
    </div>
    
    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if books.has_other_pages %}
        <div class="pagination">
            {% if books.has_previous %}
                <a href="?page=1{% if current_publisher %}&publisher={{ current_publisher }}{% endif %}{% if current_year %}&year={{ current_year }}{% endif %}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}">¬´ –ü–µ—Ä–≤–∞—è</a>
                <a href="?page={{ books.previous_page_number }}{% if current_publisher %}&publisher={{ current_publisher }}{% endif %}{% if current_year %}&year={{ current_year }}{% endif %}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}">‚Äπ –ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
            {% endif %}
            
            <span class="current">
                –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ books.number }} –∏–∑ {{ books.paginator.num_pages }}
            </span>
            
            {% if books.has_next %}
                <a href="?page={{ books.next_page_number }}{% if current_publisher %}&publisher={{ current_publisher }}{% endif %}{% if current_year %}&year={{ current_year }}{% endif %}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}">–°–ª–µ–¥—É—é—â–∞—è ‚Ä∫</a>
                <a href="?page={{ books.paginator.num_pages }}{% if current_publisher %}&publisher={{ current_publisher }}{% endif %}{% if current_year %}&year={{ current_year }}{% endif %}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}">–ü–æ—Å–ª–µ–¥–Ω—è—è ¬ª</a>
            {% endif %}
        </div>
    {% endif %}
{% else %}
    <div class="card">
        <p>–ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. <a href="{% url 'books:book_create' %}">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∫–Ω–∏–≥—É</a></p>
    </div>
{% endif %}
{% endblock %}

