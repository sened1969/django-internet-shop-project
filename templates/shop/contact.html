{% extends "shop/base.html" %}
{% load static %}

{% block title %}Связаться с нами - {{ block.super }}{% endblock %}

{% block content %}
    <div class="form-container">
        <h1 class="page-title">Связаться с нами</h1>
        
        <div id="ajax-message" class="ajax-message" style="display: none;"></div>
        
        <form method="post" id="contact-form" class="form">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
                <div class="alert alert-error">
                    {{ form.non_field_errors }}
                </div>
            {% endif %}
            
            <div class="form-group">
                <label for="{{ form.name.id_for_label }}" class="form-label">
                    {{ form.name.label }}
                </label>
                {{ form.name }}
                {% if form.name.errors %}
                    <div class="error-message">{{ form.name.errors }}</div>
                {% endif %}
                {% if form.name.help_text %}
                    <small class="form-help">{{ form.name.help_text }}</small>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.email.id_for_label }}" class="form-label">
                    {{ form.email.label }}
                </label>
                {{ form.email }}
                {% if form.email.errors %}
                    <div class="error-message">{{ form.email.errors }}</div>
                {% endif %}
                {% if form.email.help_text %}
                    <small class="form-help">{{ form.email.help_text }}</small>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.message.id_for_label }}" class="form-label">
                    {{ form.message.label }}
                </label>
                {{ form.message }}
                {% if form.message.errors %}
                    <div class="error-message">{{ form.message.errors }}</div>
                {% endif %}
                {% if form.message.help_text %}
                    <small class="form-help">{{ form.message.help_text }}</small>
                {% endif %}
            </div>
            
            <div class="form-actions">
                <button type="submit" id="submit-btn" class="btn btn-primary">Отправить сообщение</button>
            </div>
        </form>
    </div>
    
    <script>
        // Ajax обработка формы отправки сообщения
        document.getElementById('contact-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const form = this;
            const formData = new FormData(form);
            const submitBtn = document.getElementById('submit-btn');
            const messageDiv = document.getElementById('ajax-message');
            
            // Отключаем кнопку отправки
            submitBtn.disabled = true;
            submitBtn.textContent = 'Отправка...';
            
            // Очищаем предыдущие сообщения
            messageDiv.style.display = 'none';
            messageDiv.className = 'ajax-message';
            
            // Получаем CSRF токен
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch('{% url "shop:contact_ajax" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Успешная отправка
                    messageDiv.textContent = data.message;
                    messageDiv.className = 'ajax-message alert-success';
                    messageDiv.style.display = 'block';
                    
                    // Очищаем форму
                    form.reset();
                    
                    // Прокручиваем к сообщению
                    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    // Ошибки валидации
                    let errorHtml = '<strong>Ошибки валидации:</strong><ul>';
                    for (let field in data.errors) {
                        data.errors[field].forEach(error => {
                            errorHtml += `<li>${error}</li>`;
                        });
                    }
                    errorHtml += '</ul>';
                    
                    messageDiv.innerHTML = errorHtml;
                    messageDiv.className = 'ajax-message alert-error';
                    messageDiv.style.display = 'block';
                    
                    // Прокручиваем к сообщению
                    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                messageDiv.textContent = 'Произошла ошибка при отправке сообщения. Попробуйте еще раз.';
                messageDiv.className = 'ajax-message alert-error';
                messageDiv.style.display = 'block';
            })
            .finally(() => {
                // Включаем кнопку обратно
                submitBtn.disabled = false;
                submitBtn.textContent = 'Отправить сообщение';
            });
        });
    </script>
{% endblock %}

