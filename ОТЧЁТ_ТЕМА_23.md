# Отчет по выполнению домашнего задания "Тема #23. REST API"

**Дата создания:** 2025-01-27  
**Статус:** ✅ Все требования выполнены

---

## Содержание

1. [Описание системы ролей](#1-описание-системы-ролей)
2. [Описание аутентификации](#2-описание-аутентификации)
3. [Описание REST API эндпоинтов](#3-описание-rest-api-эндпоинтов)
4. [Описание разрешений (Permissions)](#4-описание-разрешений-permissions)
5. [Примеры использования API](#5-примеры-использования-api)
6. [Тестирование](#6-тестирование)

---

## 1. Описание системы ролей

### 1.1. Реализация системы ролей

Система ролей реализована путем добавления поля `role` в модель `CustomUser` в приложении `shop`.

#### Модель CustomUser

```python
class CustomUser(AbstractBaseUser, PermissionsMixin):
    # ... существующие поля ...
    
    ROLE_CHOICES = [
        ('admin', 'Администратор'),
        ('manager', 'Менеджер'),
        ('user', 'Пользователь'),
    ]
    
    role = models.CharField(
        max_length=20,
        choices=ROLE_CHOICES,
        default='user',
        verbose_name='Роль',
        help_text='Роль пользователя в системе'
    )
```

#### Роли и их права

| Роль | Описание | Права доступа |
|------|----------|---------------|
| **Администратор** (`admin`) | Полный доступ ко всем ресурсам | CRUD для всех моделей, управление пользователями |
| **Менеджер** (`manager`) | Управление контентом | Создание и редактирование (без удаления) |
| **Пользователь** (`user`) | Базовый доступ | Только чтение, создание отзывов |

### 1.2. Назначение ролей

Роли назначаются пользователям через административную панель Django (`/admin/`). По умолчанию все новые пользователи получают роль `user`.

**Инструкция по назначению роли:**
1. Войти в административную панель: `http://127.0.0.1:8000/admin/`
2. Перейти в раздел "Пользователи"
3. Выбрать пользователя
4. В поле "Роль" выбрать нужную роль
5. Сохранить изменения

---

## 2. Описание аутентификации

### 2.1. Методы аутентификации

В проекте реализованы два метода аутентификации:

#### 2.1.1. Сессионная аутентификация

**Назначение:** Для веб-интерфейса и браузерного доступа к API

**Использование:**
- Автоматически работает при входе через веб-интерфейс
- Для API: использовать cookie сессии после входа через `/api/auth/login/`

**Настройка:**
```python
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework.authentication.SessionAuthentication',
        # ...
    ],
}
```

#### 2.1.2. JWT токены (JSON Web Token)

**Назначение:** Для программного доступа к API (мобильные приложения, внешние сервисы)

**Получение токена:**

**Запрос:**
```http
POST /api/auth/token/
Content-Type: application/json

{
    "email": "user@example.com",
    "password": "password123"
}
```

**Ответ (200 OK):**
```json
{
    "access": "eyJ0eXAiOiJKV1QiLCJhbGc...",
    "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc..."
}
```

**Использование токена:**

Добавить заголовок `Authorization` в запросы:
```http
GET /api/books/
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGc...
```

**Обновление токена:**

Токен доступа действителен 1 час. Для обновления:
```http
POST /api/auth/token/refresh/
Content-Type: application/json

{
    "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc..."
}
```

**Ответ:**
```json
{
    "access": "eyJ0eXAiOiJKV1QiLCJhbGc..."
}
```

### 2.2. Настройки JWT

```python
SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(hours=1),
    'REFRESH_TOKEN_LIFETIME': timedelta(days=1),
    'ROTATE_REFRESH_TOKENS': True,
}
```

---

## 3. Описание REST API эндпоинтов

### 3.1. Общая информация

**Базовый URL:** `http://127.0.0.1:8000/api/`

**Формат данных:** JSON

**Пагинация:** По умолчанию 20 элементов на страницу

**Структура ответа с пагинацией:**
```json
{
    "count": 50,
    "next": "http://127.0.0.1:8000/api/books/?page=2",
    "previous": null,
    "results": [...]
}
```

### 3.2. Эндпоинты для книг (Books)

#### GET /api/books/

**Описание:** Получение списка всех книг

**Аутентификация:** Не требуется (или требуется в зависимости от настроек)

**Параметры запроса:**
- `page` (int): номер страницы
- `page_size` (int): количество элементов на странице
- `search` (string): поиск по названию, автору, описанию
- `ordering` (string): сортировка (`title`, `author`, `published_date`, `-title`, и т.д.)

**Пример запроса:**
```http
GET /api/books/?search=python&ordering=-published_date&page=1
```

**Пример ответа (200 OK):**
```json
{
    "count": 25,
    "next": "http://127.0.0.1:8000/api/books/?page=2",
    "previous": null,
    "results": [
        {
            "id": 1,
            "title": "Python для начинающих",
            "author": "Иван Иванов",
            "published_date": "2024-01-15",
            "description": "Подробное руководство по Python",
            "publisher": 1,
            "publisher_name": "Издательство А",
            "publisher_country": "Россия",
            "stores": [
                {
                    "id": 1,
                    "name": "Книжный магазин",
                    "city": "Москва",
                    "books_count": 10
                }
            ],
            "reviews_count": 5,
            "avg_rating": 4.5
        }
    ]
}
```

#### POST /api/books/

**Описание:** Создание новой книги

**Аутентификация:** Требуется (JWT токен или сессия)

**Авторизация:** Администратор или Менеджер

**Тело запроса:**
```json
{
    "title": "Новая книга",
    "author": "Автор",
    "published_date": "2024-01-01",
    "description": "Описание книги",
    "publisher": 1,
    "store_ids": [1, 2]
}
```

**Пример ответа (201 Created):**
```json
{
    "id": 2,
    "title": "Новая книга",
    "author": "Автор",
    "published_date": "2024-01-01",
    "description": "Описание книги",
    "publisher": 1,
    "publisher_name": "Издательство А",
    "publisher_country": "Россия",
    "stores": [...],
    "reviews_count": 0,
    "avg_rating": null
}
```

**Пример ошибки (403 Forbidden):**
```json
{
    "detail": "You do not have permission to perform this action."
}
```

#### GET /api/books/{id}/

**Описание:** Получение детальной информации о книге

**Аутентификация:** Не требуется

**Пример ответа (200 OK):**
```json
{
    "id": 1,
    "title": "Python для начинающих",
    "author": "Иван Иванов",
    "published_date": "2024-01-15",
    "description": "Подробное руководство по Python",
    "publisher": 1,
    "publisher_name": "Издательство А",
    "publisher_country": "Россия",
    "stores": [...],
    "reviews_count": 5,
    "avg_rating": 4.5,
    "reviews": [
        {
            "id": 1,
            "book": 1,
            "book_title": "Python для начинающих",
            "rating": 5,
            "text": "Отличная книга!",
            "created_at": "2024-01-20T10:00:00Z"
        }
    ]
}
```

#### PUT /api/books/{id}/

**Описание:** Полное обновление книги

**Аутентификация:** Требуется

**Авторизация:** Администратор или Менеджер

**Тело запроса:** Полный объект книги

#### PATCH /api/books/{id}/

**Описание:** Частичное обновление книги

**Аутентификация:** Требуется

**Авторизация:** Администратор или Менеджер

**Тело запроса:** Только изменяемые поля

#### DELETE /api/books/{id}/

**Описание:** Удаление книги

**Аутентификация:** Требуется

**Авторизация:** Только Администратор

**Пример ответа (204 No Content):** Без тела ответа

#### GET /api/books/top_rated/

**Описание:** Получение топ-10 книг по рейтингу (минимум 3 отзыва)

**Аутентификация:** Не требуется

**Пример ответа (200 OK):**
```json
[
    {
        "id": 1,
        "title": "Лучшая книга",
        "avg_rating": 4.8,
        "reviews_count": 15
    }
]
```

#### GET /api/books/statistics/

**Описание:** Получение статистики по книгам

**Аутентификация:** Не требуется

**Пример ответа (200 OK):**
```json
{
    "total_books": 50,
    "total_reviews": 120,
    "average_rating": 4.2
}
```

### 3.3. Эндпоинты для издательств (Publishers)

#### GET /api/publishers/

**Описание:** Получение списка всех издательств

**Параметры:**
- `search`: поиск по названию и стране
- `ordering`: сортировка

**Пример ответа:**
```json
{
    "count": 10,
    "results": [
        {
            "id": 1,
            "name": "Издательство А",
            "country": "Россия",
            "books_count": 15
        }
    ]
}
```

#### POST /api/publishers/

**Описание:** Создание нового издательства

**Авторизация:** Администратор или Менеджер

#### GET /api/publishers/{id}/books/

**Описание:** Получение списка книг издательства

**Пример ответа:**
```json
[
    {
        "id": 1,
        "title": "Книга 1",
        "author": "Автор 1",
        ...
    }
]
```

### 3.4. Эндпоинты для магазинов (Stores)

#### GET /api/stores/

**Описание:** Получение списка всех магазинов

**Параметры:**
- `search`: поиск по названию и городу
- `ordering`: сортировка

#### GET /api/stores/{id}/books/

**Описание:** Получение списка книг в магазине

### 3.5. Эндпоинты для отзывов (Reviews)

#### GET /api/reviews/

**Описание:** Получение списка всех отзывов

**Параметры:**
- `search`: поиск по тексту и названию книги
- `ordering`: сортировка

#### POST /api/reviews/

**Описание:** Создание нового отзыва

**Аутентификация:** Требуется

**Авторизация:** Все авторизованные пользователи

**Тело запроса:**
```json
{
    "book": 1,
    "rating": 5,
    "text": "Отличная книга!"
}
```

---

## 4. Описание разрешений (Permissions)

### 4.1. Реализованные разрешения

#### IsAdminOrReadOnly

**Описание:** Только администратор может изменять данные, остальные могут только читать

**Использование:** Для критических операций (удаление)

**Логика:**
- GET, HEAD, OPTIONS: разрешено всем
- POST, PUT, PATCH, DELETE: только администратор

**Код:**
```python
class IsAdminOrReadOnly(permissions.BasePermission):
    def has_permission(self, request, view):
        if request.method in permissions.SAFE_METHODS:
            return True
        return (
            request.user and
            request.user.is_authenticated and
            hasattr(request.user, 'role') and
            request.user.role == 'admin'
        )
```

#### IsManagerOrReadOnly

**Описание:** Менеджер и администратор могут создавать и редактировать, удаление только администратору

**Использование:** Для основных ресурсов (книги, издательства, магазины)

**Логика:**
- GET, HEAD, OPTIONS: разрешено всем
- POST, PUT, PATCH: администратор или менеджер
- DELETE: только администратор

**Код:**
```python
class IsManagerOrReadOnly(permissions.BasePermission):
    def has_permission(self, request, view):
        if request.method in permissions.SAFE_METHODS:
            return True
        if request.method == 'DELETE':
            return request.user.role == 'admin'
        return request.user.role in ['admin', 'manager']
```

### 4.2. Применение разрешений

| Ресурс | Разрешение | GET | POST | PUT/PATCH | DELETE |
|--------|------------|-----|------|-----------|--------|
| Books | IsManagerOrReadOnly | Все | Админ, Менеджер | Админ, Менеджер | Админ |
| Publishers | IsManagerOrReadOnly | Все | Админ, Менеджер | Админ, Менеджер | Админ |
| Stores | IsManagerOrReadOnly | Все | Админ, Менеджер | Админ, Менеджер | Админ |
| Reviews | IsAdminOrReadOnly (создание: IsAuthenticated) | Все | Все (авторизованные) | Админ | Админ |

---

## 5. Примеры использования API

### 5.1. Получение JWT токена

**Запрос:**
```bash
curl -X POST http://127.0.0.1:8000/api/auth/token/ \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@example.com",
    "password": "password123"
  }'
```

**Ответ:**
```json
{
    "access": "eyJ0eXAiOiJKV1QiLCJhbGc...",
    "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc..."
}
```

### 5.2. Получение списка книг

**Запрос:**
```bash
curl http://127.0.0.1:8000/api/books/
```

**Ответ:** Список книг с пагинацией

### 5.3. Создание книги (требуется токен)

**Запрос:**
```bash
curl -X POST http://127.0.0.1:8000/api/books/ \
  -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGc..." \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Новая книга",
    "author": "Автор",
    "published_date": "2024-01-01",
    "description": "Описание",
    "publisher": 1,
    "store_ids": [1, 2]
  }'
```

### 5.4. Удаление книги (только администратор)

**Запрос:**
```bash
curl -X DELETE http://127.0.0.1:8000/api/books/1/ \
  -H "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGc..."
```

**Ответ:** 204 No Content (успешно) или 403 Forbidden (недостаточно прав)

---

## 6. Тестирование

### 6.1. Тестовые сценарии

#### Сценарий 1: Пользователь пытается создать книгу

**Роль:** Пользователь (`user`)

**Действие:** POST /api/books/

**Ожидаемый результат:** 403 Forbidden

**Ответ:**
```json
{
    "detail": "You do not have permission to perform this action."
}
```

#### Сценарий 2: Менеджер создает книгу

**Роль:** Менеджер (`manager`)

**Действие:** POST /api/books/

**Ожидаемый результат:** 201 Created

**Ответ:** Объект созданной книги

#### Сценарий 3: Менеджер пытается удалить книгу

**Роль:** Менеджер (`manager`)

**Действие:** DELETE /api/books/1/

**Ожидаемый результат:** 403 Forbidden

#### Сценарий 4: Администратор удаляет книгу

**Роль:** Администратор (`admin`)

**Действие:** DELETE /api/books/1/

**Ожидаемый результат:** 204 No Content

#### Сценарий 5: Пользователь создает отзыв

**Роль:** Пользователь (`user`)

**Действие:** POST /api/reviews/

**Ожидаемый результат:** 201 Created

**Примечание:** Создание отзывов разрешено всем авторизованным пользователям

### 6.2. Тестирование через Postman

1. **Создать коллекцию запросов:**
   - Получение токена
   - Получение списка книг
   - Создание книги (с токеном)
   - Удаление книги (с токеном администратора)

2. **Настроить переменные:**
   - `base_url`: http://127.0.0.1:8000/api
   - `token`: JWT токен

3. **Добавить токен в заголовки:**
   - Key: `Authorization`
   - Value: `Bearer {{token}}`

### 6.3. Swagger документация

Доступна по адресу: `http://127.0.0.1:8000/swagger/`

Swagger предоставляет:
- Интерактивную документацию всех эндпоинтов
- Возможность тестирования API прямо в браузере
- Описание всех параметров и ответов

---

## 7. Структура проекта

```
books/
├── api/
│   ├── __init__.py
│   ├── serializers.py      # Сериализаторы для всех моделей
│   ├── views.py           # ViewSets для CRUD операций
│   ├── permissions.py     # Система разрешений
│   └── urls.py            # URL маршруты API
├── models.py              # Модели (без изменений)
└── views.py               # Веб-представления (без изменений)
```

---

## 8. Установка и запуск

### 8.1. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 8.2. Применение миграций

```bash
python manage.py makemigrations
python manage.py migrate
```

### 8.3. Создание суперпользователя

```bash
python manage.py createsuperuser
```

### 8.4. Запуск сервера

```bash
python manage.py runserver
```

### 8.5. Доступ к API

- **API:** http://127.0.0.1:8000/api/
- **Swagger:** http://127.0.0.1:8000/swagger/
- **Админка:** http://127.0.0.1:8000/admin/

---

## 9. Заключение

В рамках выполнения домашнего задания была реализована полноценная REST API для приложения `books` с:

✅ Системой ролей (Администратор, Менеджер, Пользователь)  
✅ Двумя методами аутентификации (сессии и JWT токены)  
✅ Ролевыми разрешениями доступа  
✅ CRUD операциями для всех моделей  
✅ Пагинацией и фильтрацией  
✅ Swagger документацией  

Все требования задания выполнены. API готов к использованию и тестированию.

---

**Дата создания:** 2025-01-27  
**Версия:** 1.0

