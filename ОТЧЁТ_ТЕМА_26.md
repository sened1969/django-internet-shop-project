# ОТЧЁТ_ТЕМА_26

**Тема:** PostgreSQL(PG4) - Добавление товаров и ограничение доступа

**Дата выполнения:** 2025-01-27

**Вариант сдачи:** Вариант 1 - Базовая реализация

---

## 1. Введение

### Описание темы

Тема #26 посвящена реализации функциональности добавления товаров через интерфейс сайта и настройке ограничения доступа к корзине покупок. Основные задачи включают:

- Создание формы для добавления новых товаров
- Реализацию представления для обработки формы
- Настройку ограничения доступа к корзине только для авторизованных пользователей
- Интеграцию новых функций с существующей системой регистрации и авторизации

### Выбранный вариант сдачи

**Вариант 1: Базовая реализация**

Выбран базовый вариант реализации, который включает:
- Форму добавления товаров с необходимыми полями
- Представление с ограничением доступа через декоратор `@login_required`
- Шаблон для отображения формы
- Ограничение доступа к корзине для авторизованных пользователей

### Цели реализации

1. Реализовать возможность добавления товаров через интерфейс сайта (без использования админки Django)
2. Обеспечить ограничение доступа к корзине только для авторизованных пользователей
3. Интегрировать новые функции с существующей системой авторизации
4. Обеспечить удобный пользовательский интерфейс с понятными сообщениями

---

## 2. Реализация формы добавления товаров

### Описание созданной формы

Создана форма `ProductForm` в файле `shop/forms.py`, которая наследуется от `forms.ModelForm` и работает с моделью `Product`.

### Поля формы и их назначение

Форма включает следующие поля:

1. **name** (CharField) - Название товара
   - Обязательное поле
   - Виджет: TextInput с классом `form-control`
   - Placeholder: "Введите название товара"

2. **description** (TextField) - Описание товара
   - Обязательное поле
   - Виджет: Textarea с 5 строками
   - Placeholder: "Введите описание товара"

3. **price** (DecimalField) - Цена товара
   - Обязательное поле
   - Виджет: NumberInput с шагом 0.01 и минимумом 0.01
   - Placeholder: "0.00"

4. **image** (ImageField) - Изображение товара
   - Необязательное поле
   - Виджет: FileInput с accept="image/*"
   - Позволяет загружать только изображения

5. **category** (ForeignKey) - Категория товара
   - Необязательное поле
   - Виджет: Select для выбора из существующих категорий
   - Связь с моделью `Category`

6. **stock** (IntegerField) - Количество на складе
   - Обязательное поле
   - Виджет: NumberInput с минимумом 0
   - Placeholder: "0"

### Пример кода формы

```python
class ProductForm(forms.ModelForm):
    """
    Форма для добавления нового товара.
    
    Поля:
        name: Название товара
        description: Описание товара
        price: Цена товара
        image: Изображение товара
        category: Категория товара
        stock: Количество на складе
    """
    
    class Meta:
        model = Product
        fields = ['name', 'description', 'price', 'image', 'category', 'stock']
        widgets = {
            'name': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': 'Введите название товара',
                'required': True
            }),
            'description': forms.Textarea(attrs={
                'class': 'form-control',
                'rows': 5,
                'placeholder': 'Введите описание товара',
                'required': True
            }),
            'price': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01',
                'min': '0.01',
                'placeholder': '0.00',
                'required': True
            }),
            'image': forms.FileInput(attrs={
                'class': 'form-control',
                'accept': 'image/*'
            }),
            'category': forms.Select(attrs={
                'class': 'form-control'
            }),
            'stock': forms.NumberInput(attrs={
                'class': 'form-control',
                'min': '0',
                'placeholder': '0',
                'required': True
            }),
        }
        labels = {
            'name': 'Название товара',
            'description': 'Описание товара',
            'price': 'Цена товара',
            'image': 'Изображение товара',
            'category': 'Категория товара',
            'stock': 'Количество на складе',
        }
        help_texts = {
            'name': 'Введите название товара',
            'description': 'Введите подробное описание товара',
            'price': 'Цена товара в рублях',
            'image': 'Загрузите изображение товара (необязательно)',
            'category': 'Выберите категорию товара (необязательно)',
            'stock': 'Количество товара на складе',
        }
```

### Особенности реализации

- Использован `forms.ModelForm` для автоматической генерации полей на основе модели `Product`
- Все поля имеют кастомные виджеты с классами стилей для единообразного оформления
- Добавлены подсказки (help_texts) для улучшения пользовательского опыта
- Поля с изображением используют `enctype="multipart/form-data"` для корректной загрузки файлов

---

## 3. Реализация представления добавления товара

### Описание функции add_product()

Создана функция `add_product()` в файле `shop/views.py`, которая обрабатывает запросы на добавление нового товара.

### Обработка GET и POST запросов

**GET запрос:**
- Отображает пустую форму `ProductForm`
- Рендерит шаблон `add_product.html`
- Передает форму в контекст шаблона

**POST запрос:**
- Получает данные формы из `request.POST` и `request.FILES`
- Создает экземпляр формы с переданными данными
- Выполняет валидацию через `form.is_valid()`
- При успешной валидации сохраняет товар в базу данных
- Отображает сообщение об успехе через `messages.success()`
- Выполняет редирект на страницу добавленного товара

### Ограничение доступа через @login_required

Функция защищена декоратором `@login_required`, который:
- Проверяет, авторизован ли пользователь
- Если пользователь не авторизован, выполняет редирект на страницу входа (`/login/`)
- Добавляет параметр `?next=/product/add/` для возврата на страницу формы после входа

### Пример кода функции

```python
@login_required
def add_product(request):
    """
    Добавление нового товара через интерфейс сайта.
    
    Только авторизованные пользователи могут добавлять товары.
    """
    if request.method == 'POST':
        form = ProductForm(request.POST, request.FILES)
        if form.is_valid():
            product = form.save()
            messages.success(request, f'Товар "{product.name}" успешно добавлен!')
            return redirect('shop:product_detail', product_id=product.id)
    else:
        form = ProductForm()
    
    context = {
        'form': form,
        'page_title': 'Добавить товар',
    }
    return render(request, 'shop/add_product.html', context)
```

### Особенности реализации

- Использован декоратор `@login_required` для ограничения доступа
- Обработка файлов через `request.FILES` для загрузки изображений
- Сообщения об успехе через систему сообщений Django
- Редирект на страницу товара после успешного добавления

---

## 4. Создание шаблона

### Описание шаблона add_product.html

Создан шаблон `templates/shop/add_product.html` для отображения формы добавления товара.

### Структура шаблона

Шаблон включает:

1. **Наследование от базового шаблона** `shop/base.html`
2. **Заголовок страницы** "Добавить новый товар"
3. **Форма с полями:**
   - Название товара
   - Описание товара
   - Цена и количество на складе (в одной строке)
   - Категория товара
   - Изображение товара
4. **Обработка ошибок валидации:**
   - Отображение ошибок под каждым полем
   - Отображение общих ошибок формы
   - Подсказки для каждого поля
5. **Кнопки действий:**
   - "Добавить товар" (отправка формы)
   - "Отмена" (возврат к списку товаров)

### Обработка ошибок валидации

Шаблон обрабатывает ошибки следующим образом:

- **Ошибки полей:** Отображаются под соответствующим полем через `{{ form.field.errors }}`
- **Общие ошибки:** Отображаются в начале формы через `{{ form.non_field_errors }}`
- **Подсказки:** Отображаются под полями через `{{ form.field.help_text }}`
- **Визуальное выделение:** Ошибки отображаются в блоке с классом `error-message`

### Пример структуры шаблона

```html
{% extends "shop/base.html" %}
{% load static %}

{% block title %}Добавить товар - {{ block.super }}{% endblock %}

{% block content %}
    <div class="form-container">
        <h1 class="page-title">Добавить новый товар</h1>
        
        <form method="post" enctype="multipart/form-data" class="form">
            {% csrf_token %}
            
            <!-- Обработка общих ошибок -->
            {% if form.non_field_errors %}
                <div class="alert alert-error">
                    {{ form.non_field_errors }}
                </div>
            {% endif %}
            
            <!-- Поля формы с обработкой ошибок -->
            <div class="form-group">
                <label for="{{ form.name.id_for_label }}" class="form-label">
                    {{ form.name.label }}
                    {% if form.name.field.required %}<span class="required">*</span>{% endif %}
                </label>
                {{ form.name }}
                {% if form.name.errors %}
                    <div class="error-message">{{ form.name.errors }}</div>
                {% endif %}
                {% if form.name.help_text %}
                    <small class="form-help">{{ form.name.help_text }}</small>
                {% endif %}
            </div>
            
            <!-- ... остальные поля ... -->
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Добавить товар</button>
                <a href="{% url 'shop:product_list' %}" class="btn btn-secondary">Отмена</a>
            </div>
        </form>
    </div>
{% endblock %}
```

### Особенности реализации

- Использован `enctype="multipart/form-data"` для загрузки файлов
- Все поля имеют метки и подсказки
- Обязательные поля помечены звездочкой
- Единообразное оформление с остальными формами проекта

---

## 5. Ограничение доступа к корзине

### Изменения в функции add_to_cart()

Функция `add_to_cart()` была изменена для ограничения доступа только авторизованным пользователям.

**До изменений:**
- Функция работала для всех пользователей (включая анонимных)
- Поддерживала сессионную корзину для анонимных пользователей

**После изменений:**
- Добавлен декоратор `@login_required`
- Удалена поддержка сессионной корзины для анонимных пользователей
- Только авторизованные пользователи могут добавлять товары в корзину

### Пример кода измененной функции

```python
@login_required
def add_to_cart(request, product_id):
    """
    Добавление товара в корзину.
    
    Только авторизованные пользователи могут добавлять товары в корзину.
    """
    product = get_object_or_404(Product, id=product_id)
    quantity = int(request.POST.get('quantity', 1))
    
    # Для авторизованных пользователей
    cart, created = Cart.objects.get_or_create(user=request.user)
    cart_item, created = CartItem.objects.get_or_create(
        cart=cart,
        product=product,
        defaults={'quantity': quantity}
    )
    if not created:
        cart_item.quantity += quantity
        cart_item.save()
    
    messages.success(request, f'{product.name} добавлен в корзину.')
    return redirect('shop:product_detail', product_id=product_id)
```

### Изменения в шаблоне product_detail.html

В шаблоне `product_detail.html` добавлена проверка авторизации перед отображением кнопки "Добавить в корзину".

**Для авторизованных пользователей:**
- Отображается кнопка "Добавить в корзину" (если товар есть на складе)
- Или сообщение "Товар временно отсутствует на складе" (если stock = 0)

**Для неавторизованных пользователей:**
- Отображается сообщение "Авторизуйтесь для добавления в корзину"
- Отображается кнопка "Войти" для перехода на страницу авторизации

### Пример кода изменений в шаблоне

```html
<!-- Кнопка добавления в корзину (только для авторизованных пользователей) -->
{% if user.is_authenticated %}
    {% if product.stock > 0 %}
        <form method="post" action="{% url 'shop:add_to_cart' product.id %}" class="add-to-cart-form">
            {% csrf_token %}
            <input type="hidden" name="quantity" value="1">
            <button type="submit" class="btn btn-primary">Добавить в корзину</button>
        </form>
    {% else %}
        <div class="out-of-stock">
            <p>Товар временно отсутствует на складе</p>
        </div>
    {% endif %}
{% else %}
    <div class="auth-required">
        <p class="auth-message">Авторизуйтесь для добавления в корзину</p>
        <a href="{% url 'shop:login' %}" class="btn btn-primary">Войти</a>
    </div>
{% endif %}
```

### Проверка авторизации пользователя

Проверка выполняется на двух уровнях:

1. **На уровне представления (View):**
   - Декоратор `@login_required` проверяет авторизацию перед выполнением функции
   - Если пользователь не авторизован, выполняется редирект на `/login/?next=/cart/add/id/`

2. **На уровне шаблона:**
   - Условный оператор `{% if user.is_authenticated %}` проверяет статус авторизации
   - Разные элементы интерфейса отображаются в зависимости от статуса

---

## 6. Добавление кнопки "Добавить товар"

### Изменения в шаблоне product_list.html

В шаблон `product_list.html` добавлена кнопка "Добавить товар" в верхней части страницы, перед списком товаров.

### Условие отображения кнопки

Кнопка отображается только для авторизованных пользователей через проверку `{% if user.is_authenticated %}`.

**Для авторизованных пользователей:**
- Видна кнопка "➕ Добавить товар"
- Кнопка ведет на страницу `/product/add/`

**Для неавторизованных пользователей:**
- Кнопка скрыта
- В меню навигации видны кнопки "Регистрация" и "Войти"

### Пример кода изменений

```html
{% block content %}
    <h1 class="page-title">Каталог товаров</h1>
    
    <!-- Кнопка добавления товара (только для авторизованных пользователей) -->
    {% if user.is_authenticated %}
        <div class="add-product-section" style="margin-bottom: 20px;">
            <a href="{% url 'shop:add_product' %}" class="btn btn-primary">➕ Добавить товар</a>
        </div>
    {% endif %}
    
    <!-- Форма фильтрации и сортировки -->
    <!-- ... остальной код ... -->
{% endblock %}
```

### Особенности реализации

- Кнопка размещена в логичном месте (вверху страницы перед списком товаров)
- Используется иконка ➕ для визуального выделения
- Кнопка имеет стиль `btn btn-primary` для единообразия с остальными элементами интерфейса
- Условие отображения обеспечивает безопасность и удобство использования

---

## 7. Тестирование

### Примеры использования

#### 7.1. Добавление товара через форму

**Шаги:**
1. Войти в систему как авторизованный пользователь
2. Перейти на страницу списка товаров (`http://127.0.0.1:8000/`)
3. Нажать кнопку "➕ Добавить товар"
4. Заполнить форму:
   - Название: "Тестовый товар"
   - Описание: "Описание тестового товара"
   - Цена: 1000.00
   - Количество: 10
   - Категория: выбрать из списка (опционально)
   - Изображение: выбрать файл (опционально)
5. Нажать "Добавить товар"

**Ожидаемый результат:**
- Товар сохраняется в базу данных
- Отображается сообщение "Товар 'Тестовый товар' успешно добавлен!"
- Выполняется редирект на страницу добавленного товара
- Товар отображается в списке товаров

#### 7.2. Проверка ограничения доступа к корзине

**Для авторизованного пользователя:**
1. Войти в систему
2. Перейти на страницу любого товара (`http://127.0.0.1:8000/product/2/`)
3. Проверить наличие кнопки "Добавить в корзину"
4. Нажать кнопку "Добавить в корзину"

**Ожидаемый результат:**
- Кнопка "Добавить в корзину" видна и активна
- После нажатия товар добавляется в корзину
- Отображается сообщение "Название товара добавлен в корзину."
- Товар отображается в корзине (`http://127.0.0.1:8000/cart/`)

**Для неавторизованного пользователя:**
1. Выйти из системы (если был авторизован)
2. Перейти на страницу любого товара (`http://127.0.0.1:8000/product/2/`)
3. Проверить отображение сообщения

**Ожидаемый результат:**
- Кнопка "Добавить в корзину" не отображается
- Вместо неё отображается сообщение "Авторизуйтесь для добавления в корзину"
- Отображается кнопка "Войти" для перехода на страницу авторизации

#### 7.3. Проверка ограничения доступа к форме добавления товара

**Для авторизованного пользователя:**
1. Войти в систему
2. Перейти на страницу списка товаров
3. Нажать кнопку "➕ Добавить товар"

**Ожидаемый результат:**
- Открывается страница с формой добавления товара
- Форма отображается корректно со всеми полями

**Для неавторизованного пользователя:**
1. Выйти из системы
2. Попытаться перейти напрямую на `/product/add/`

**Ожидаемый результат:**
- Выполняется редирект на страницу входа (`/login/?next=/product/add/`)
- После входа выполняется редирект обратно на страницу формы

### Описание скриншотов

Созданы следующие скриншоты для демонстрации функциональности:

1. **01_форма_добавления_товара_пустая.png** - Пустая форма добавления товара
2. **02_форма_добавления_товара_заполненная.png** - Форма с заполненными данными
3. **03_форма_добавления_товара_ошибки.png** - Форма с ошибками валидации
4. **04_успешное_добавление_товара.png** - Сообщение об успешном добавлении товара
5. **05_кнопка_добавить_товар_авторизован.png** - Кнопка "Добавить товар" для авторизованного пользователя
6. **06_кнопка_добавить_товар_неавторизован.png** - Отсутствие кнопки для неавторизованного пользователя
7. **07_кнопка_добавить_в_корзину_авторизован.png** - Кнопка "Добавить в корзину" для авторизованного пользователя
8. **08_сообщение_авторизуйтесь_для_корзины.png** - Сообщение для неавторизованного пользователя
9. **09_успешное_добавление_в_корзину.png** - Сообщение об успешном добавлении в корзину
10. **10_редирект_на_вход_при_добавлении_в_корзину.png** - Редирект на страницу входа
11. **11_корзина_с_товарами.png** - Корзина с добавленными товарами

### Проверка функциональности

**Проверенные сценарии:**

✅ Форма добавления товара работает корректно
✅ Валидация полей формы работает правильно
✅ Ошибки валидации отображаются корректно
✅ Товары сохраняются в базу данных
✅ Редирект на страницу товара выполняется после успешного добавления
✅ Ограничение доступа к корзине работает для неавторизованных пользователей
✅ Кнопка "Добавить товар" отображается только для авторизованных пользователей
✅ Сообщение "Авторизуйтесь для добавления в корзину" отображается корректно
✅ Декоратор `@login_required` работает правильно
✅ Проверка `user.is_authenticated` в шаблонах работает корректно

---

## 8. Измененные файлы

### Список измененных файлов

1. **shop/forms.py**
   - Добавлена форма `ProductForm` для модели `Product`
   - Поля: name, description, price, image, category, stock
   - Настроены виджеты, метки и подсказки для всех полей

2. **shop/views.py**
   - Добавлена функция `add_product()` с декоратором `@login_required`
   - Изменена функция `add_to_cart()` - добавлен декоратор `@login_required`
   - Удалена поддержка сессионной корзины для анонимных пользователей

3. **shop/urls.py**
   - Добавлен маршрут `path('product/add/', views.add_product, name='add_product')`
   - Маршрут размещен перед маршрутом детальной страницы товара

4. **templates/shop/add_product.html**
   - Создан новый шаблон для формы добавления товара
   - Реализована обработка ошибок валидации
   - Добавлены подсказки для всех полей

5. **templates/shop/product_list.html**
   - Добавлена кнопка "➕ Добавить товар" в верхней части страницы
   - Кнопка отображается только для авторизованных пользователей

6. **templates/shop/product_detail.html**
   - Изменена секция с кнопкой "Добавить в корзину"
   - Добавлена проверка `{% if user.is_authenticated %}`
   - Для неавторизованных пользователей отображается сообщение с кнопкой "Войти"

### Дополнительные файлы

7. **shop/management/commands/create_test_products.py**
   - Создана management команда для создания тестовых товаров
   - Команда создает 3 тестовых товара для тестирования и скриншотов

---

## 9. Заключение

### Выводы о проделанной работе

Все требования домашнего задания по теме #26 успешно выполнены:

1. ✅ **Форма добавления товаров** реализована с использованием `forms.ModelForm`
   - Все требуемые поля присутствуют (название, описание, цена, изображение, категория)
   - Добавлено дополнительное поле `stock` для количества на складе
   - Форма имеет удобный интерфейс с подсказками и обработкой ошибок

2. ✅ **Страница добавления товара** создана и работает корректно
   - Шаблон `add_product.html` отображает форму с правильной структурой
   - Обработка GET и POST запросов реализована корректно
   - Редирект на страницу товара выполняется после успешного добавления

3. ✅ **Кнопка "Добавить товар"** добавлена на страницу списка товаров
   - Кнопка отображается только для авторизованных пользователей
   - Размещена в логичном месте (вверху страницы)

4. ✅ **Ограничение доступа к корзине** реализовано на двух уровнях
   - На уровне представления через декоратор `@login_required`
   - На уровне шаблона через проверку `user.is_authenticated`
   - Для неавторизованных пользователей отображается понятное сообщение

5. ✅ **Интеграция с существующей системой** выполнена успешно
   - Использована существующая система регистрации и авторизации
   - Новые функции работают совместно с существующими компонентами
   - Не возникло конфликтов с существующим кодом

### Возможные улучшения

В будущем можно реализовать следующие улучшения:

1. **Расширенная валидация:**
   - Проверка формата изображения на стороне сервера
   - Ограничение размера загружаемого изображения
   - Валидация уникальности названия товара в рамках категории

2. **Улучшение UX:**
   - Предпросмотр изображения перед загрузкой
   - AJAX-валидация формы без перезагрузки страницы
   - Автозаполнение некоторых полей

3. **Расширение функциональности:**
   - Редактирование товаров через интерфейс
   - Удаление товаров с подтверждением
   - Массовое редактирование товаров
   - Разделение прав доступа (только админы могут добавлять товары)

4. **Оптимизация:**
   - Кэширование списка категорий
   - Оптимизация запросов к базе данных
   - Пагинация для больших списков товаров

### Технические детали

- **Использованные технологии:** Django Forms, Django Views, Django Templates
- **Методы аутентификации:** `@login_required` декоратор, `user.is_authenticated` проверка
- **Обработка файлов:** `request.FILES` для загрузки изображений
- **Сообщения пользователю:** Django Messages Framework

---

## 10. Приложения

### Приложение A: URL маршруты

**Добавленный маршрут:**
```python
# shop/urls.py
path('product/add/', views.add_product, name='add_product'),
```

**Существующие маршруты (используются):**
```python
path('', views.product_list, name='product_list'),
path('product/<int:product_id>/', views.product_detail, name='product_detail'),
path('cart/add/<int:product_id>/', views.add_to_cart, name='add_to_cart'),
path('login/', views.login_view, name='login'),
path('register/', views.register, name='register'),
```

### Приложение B: Структура проекта

```
shop/
├── forms.py              # ProductForm добавлена
├── views.py              # add_product() добавлена, add_to_cart() изменена
├── urls.py               # Маршрут product/add/ добавлен
└── models.py             # Без изменений (используются существующие модели)

templates/shop/
├── add_product.html      # Новый шаблон
├── product_list.html     # Изменен (добавлена кнопка)
└── product_detail.html   # Изменен (ограничение доступа к корзине)
```

### Приложение C: Тестовые данные

Для тестирования созданы 3 тестовых товара через management команду:

1. **Смартфон Samsung Galaxy S21** (ID: 2)
   - Цена: 59,999.00 руб.
   - Категория: Электроника
   - На складе: 15 шт.

2. **Футболка хлопковая** (ID: 3)
   - Цена: 1,299.00 руб.
   - Категория: Одежда
   - На складе: 50 шт.

3. **Книга "Python для начинающих"** (ID: 4)
   - Цена: 2,499.00 руб.
   - Категория: Книги
   - На складе: 8 шт.

**Команда для создания:** `python manage.py create_test_products`

---

**Отчет подготовлен:** 2025-01-27  
**Статус:** ✅ Все требования выполнены, готово к сдаче
