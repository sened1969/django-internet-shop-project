# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è "–¢–µ–º–∞ #20. –ó–∞–ø—Ä–æ—Å—ã –≤ Django ORM"

## ‚úÖ –°—Ç–∞—Ç—É—Å: –í–°–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –í–´–ü–û–õ–ù–ï–ù–´

---

## üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### ‚úÖ –ó–∞–¥–∞–Ω–∏–µ 1: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏

#### 1. –°–æ–∑–¥–∞–Ω—ã —Ç—Ä–∏ –Ω–æ–≤—ã–µ –º–æ–¥–µ–ª–∏

**Publisher (–ò–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ)**
- –ü–æ–ª—è: `name` (CharField), `country` (CharField)
- –°–≤—è–∑—å: –æ–¥–∏–Ω –∫–æ –º–Ω–æ–≥–∏–º —Å Book (–æ–¥–Ω–æ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ ‚Üí –º–Ω–æ–≥–æ –∫–Ω–∏–≥)
- –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: `books/models.py`

**Store (–ö–Ω–∏–∂–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω)**
- –ü–æ–ª—è: `name` (CharField), `city` (CharField)
- –°–≤—è–∑—å: –º–Ω–æ–≥–∏–µ –∫–æ –º–Ω–æ–≥–∏–º —Å Book (–∫–Ω–∏–≥–∞ –º–æ–∂–µ—Ç –ø—Ä–æ–¥–∞–≤–∞—Ç—å—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–∞–≥–∞–∑–∏–Ω–∞—Ö)
- –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: `books/models.py`

**Review (–û—Ç–∑—ã–≤—ã –Ω–∞ –∫–Ω–∏–≥–∏)**
- –ü–æ–ª—è: `rating` (IntegerField, 1-5), `text` (TextField), `created_at` (DateTimeField)
- –°–≤—è–∑—å: –æ–¥–∏–Ω –∫–æ –º–Ω–æ–≥–∏–º —Å Book (–æ–¥–Ω–∞ –∫–Ω–∏–≥–∞ ‚Üí –º–Ω–æ–≥–æ –æ—Ç–∑—ã–≤–æ–≤)
- –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: `books/models.py`

#### 2. –°–æ–∑–¥–∞–Ω–∞ –º–æ–¥–µ–ª—å Book

**Book (–ö–Ω–∏–≥–∞)**
- –ü–æ–ª—è: `title`, `author`, `published_date`, `description`
- –°–≤—è–∑—å —Å Publisher: ForeignKey (–º–Ω–æ–≥–æ –∫–Ω–∏–≥ ‚Üí –æ–¥–Ω–æ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ)
- –°–≤—è–∑—å —Å Store: ManyToManyField (–∫–Ω–∏–≥–∞ –º–æ–∂–µ—Ç –ø—Ä–æ–¥–∞–≤–∞—Ç—å—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–∞–≥–∞–∑–∏–Ω–∞—Ö)
- –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: `books/models.py`

#### 3. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π –≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏

–í—Å–µ –º–æ–¥–µ–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ `books/admin.py`:
- ‚úÖ `PublisherAdmin` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞–º–∏
- ‚úÖ `BookAdmin` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–∏–≥–∞–º–∏ —Å –∏–Ω–ª–∞–π–Ω-—Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º –æ—Ç–∑—ã–≤–æ–≤
- ‚úÖ `StoreAdmin` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞–º–∏
- ‚úÖ `ReviewAdmin` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞–º–∏

---

### ‚úÖ –ó–∞–¥–∞–Ω–∏–µ 2: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ —Ñ–∞–π–ª–µ `books/queries.py`:

#### 1. ‚úÖ –ö–Ω–∏–≥–∏ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤ –∏–∑ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã

**–§—É–Ω–∫—Ü–∏—è:** `get_books_by_publisher_country(country)`

**–õ–æ–≥–∏–∫–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ ForeignKey: `Book.objects.filter(publisher__country=country)`

**–ü—Ä–∏–º–µ—Ä:**
```python
books = get_books_by_publisher_country('–†–æ—Å—Å–∏—è')
```

#### 2. ‚úÖ –ö–Ω–∏–≥–∏, –ø—Ä–æ–¥–∞—é—â–∏–µ—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω–∞—Ö –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞

**–§—É–Ω–∫—Ü–∏—è:** `get_books_by_store_city(city)`

**–õ–æ–≥–∏–∫–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ ManyToManyField —Å `distinct()` –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: `Book.objects.filter(stores__city=city).distinct()`

**–ü—Ä–∏–º–µ—Ä:**
```python
books = get_books_by_store_city('–ú–æ—Å–∫–≤–∞')
```

#### 3. ‚úÖ –ö–Ω–∏–≥–∏ —Å–æ —Å—Ä–µ–¥–Ω–µ–π –æ—Ü–µ–Ω–∫–æ–π –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞

**–§—É–Ω–∫—Ü–∏—è:** `get_books_with_avg_rating_above(rating_threshold)`

**–õ–æ–≥–∏–∫–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é `Avg('reviews__rating')` –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–π –æ—Ü–µ–Ω–∫–∏ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ –ø–æ—Ä–æ–≥–æ–≤–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é: `Book.objects.annotate(avg_rating=Avg('reviews__rating')).filter(avg_rating__gt=rating_threshold)`

**–ü—Ä–∏–º–µ—Ä:**
```python
books = get_books_with_avg_rating_above(4.5)
```

#### 4. ‚úÖ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥ –≤ –∫–∞–∂–¥–æ–º –º–∞–≥–∞–∑–∏–Ω–µ

**–§—É–Ω–∫—Ü–∏—è:** `get_store_books_count()`

**–õ–æ–≥–∏–∫–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é `Count('books')` –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–Ω–∏–≥: `Store.objects.annotate(books_count=Count('books')).order_by('-books_count')`

**–ü—Ä–∏–º–µ—Ä:**
```python
stores = get_store_books_count()
for store in stores:
    print(f"{store.name}: {store.books_count} –∫–Ω–∏–≥")
```

#### 5. ‚úÖ –ú–∞–≥–∞–∑–∏–Ω—ã —Å –∫–Ω–∏–≥–∞–º–∏, –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ—Å–ª–µ –¥–∞—Ç—ã

**–§—É–Ω–∫—Ü–∏—è:** `get_stores_with_books_after_date(date)`

**–õ–æ–≥–∏–∫–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ –¥–∞—Ç–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∫–Ω–∏–≥, –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É: `Store.objects.filter(books__published_date__gt=date).annotate(books_count=Count('books')).distinct().order_by('-books_count')`

**–ü—Ä–∏–º–µ—Ä:**
```python
from datetime import date
stores = get_stores_with_books_after_date(date(2010, 1, 1))
```

---

### ‚úÖ –ó–∞–¥–∞–Ω–∏–µ 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

–í—Å–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ —Ñ–∞–π–ª–µ `books/queries.py`:

#### 1. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ select_related() –¥–ª—è ForeignKey

**–§—É–Ω–∫—Ü–∏—è:** `get_books_with_publisher_optimized()`

**–õ–æ–≥–∏–∫–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `select_related('publisher')` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –æ–¥–Ω–∏–º SQL-–∑–∞–ø—Ä–æ—Å–æ–º –≤–º–µ—Å—Ç–æ N+1 –∑–∞–ø—Ä–æ—Å–æ–≤.

**–ü—Ä–∏–º–µ—Ä:**
```python
books = get_books_with_publisher_optimized()
# –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
for book in books:
    print(book.publisher.name)  # –ù–µ –≤—ã–ø–æ–ª–Ω–∏—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** –í–º–µ—Å—Ç–æ N+1 –∑–∞–ø—Ä–æ—Å–æ–≤ (1 –¥–ª—è –∫–Ω–∏–≥ + N –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞) –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ 1 –∑–∞–ø—Ä–æ—Å —Å JOIN.

#### 2. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ prefetch_related() –¥–ª—è ManyToMany

**–§—É–Ω–∫—Ü–∏—è:** `get_books_with_stores_optimized()`

**–õ–æ–≥–∏–∫–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `prefetch_related('stores')` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤ –æ–¥–Ω–∏–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º –≤–º–µ—Å—Ç–æ N –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–Ω–∏–≥–∏.

**–ü—Ä–∏–º–µ—Ä:**
```python
books = get_books_with_stores_optimized()
# –í—Å–µ –º–∞–≥–∞–∑–∏–Ω—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
for book in books:
    stores = list(book.stores.all())  # –ù–µ –≤—ã–ø–æ–ª–Ω–∏—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** –í–º–µ—Å—Ç–æ N –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ ManyToMany –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ 2 –∑–∞–ø—Ä–æ—Å–∞ (1 –¥–ª—è –∫–Ω–∏–≥ + 1 –¥–ª—è –≤—Å–µ—Ö —Å–≤—è–∑–µ–π).

#### 3. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ prefetch_related() –¥–ª—è –æ–±—Ä–∞—Ç–Ω—ã—Ö —Å–≤—è–∑–µ–π

**–§—É–Ω–∫—Ü–∏—è:** `get_books_with_reviews_optimized()`

**–õ–æ–≥–∏–∫–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `prefetch_related('reviews')` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –æ—Ç–∑—ã–≤–æ–≤ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º –≤–º–µ—Å—Ç–æ N –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–Ω–∏–≥–∏.

**–ü—Ä–∏–º–µ—Ä:**
```python
books = get_books_with_reviews_optimized()
# –í—Å–µ –æ—Ç–∑—ã–≤—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
for book in books:
    reviews = list(book.reviews.all())  # –ù–µ –≤—ã–ø–æ–ª–Ω–∏—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** –í–º–µ—Å—Ç–æ N –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Ç–∞–±–ª–∏—Ü–µ Review –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ 2 –∑–∞–ø—Ä–æ—Å–∞ (1 –¥–ª—è –∫–Ω–∏–≥ + 1 –¥–ª—è –≤—Å–µ—Ö –æ—Ç–∑—ã–≤–æ–≤).

#### 4. ‚úÖ –ü–æ–ª–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

**–§—É–Ω–∫—Ü–∏—è:** `get_books_fully_optimized()`

**–õ–æ–≥–∏–∫–∞:** –ö–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç `select_related('publisher')` –∏ `prefetch_related('stores', 'reviews')` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–∞–ø—Ä–æ—Å–æ–≤.

**–ü—Ä–∏–º–µ—Ä:**
```python
books = get_books_fully_optimized()
# –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–∞–ø—Ä–æ—Å–æ–≤
for book in books:
    print(book.publisher.name)  # –ò–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
    stores = list(book.stores.all())  # –ú–∞–≥–∞–∑–∏–Ω—ã —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    reviews = list(book.reviews.all())  # –û—Ç–∑—ã–≤—ã —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** –í–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ 3-4 –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–Ω–∏–≥.

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

```
books/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ admin.py          # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
‚îú‚îÄ‚îÄ apps.py
‚îú‚îÄ‚îÄ models.py         # –ú–æ–¥–µ–ª–∏ Publisher, Store, Book, Review
‚îú‚îÄ‚îÄ queries.py        # –ó–∞–ø—Ä–æ—Å—ã –∏–∑ –ó–∞–¥–∞–Ω–∏—è 2 –∏ 3
‚îú‚îÄ‚îÄ tests.py
‚îú‚îÄ‚îÄ views.py
‚îú‚îÄ‚îÄ migrations/       # –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ 0001_initial.py
‚îÇ   ‚îî‚îÄ‚îÄ 0002_remove_store_books_book_stores.py
‚îî‚îÄ‚îÄ README.md         # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```

---

## üîß –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø—Ä–æ–µ–∫—Ç–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ settings.py

```python
INSTALLED_APPS = [
    ...
    'shop',  # –°—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    'books',  # –ù–û–í–û–ï –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–¢–µ–º–∞ 20)
]
```

### 2. –°–æ–∑–¥–∞–Ω—ã –º–∏–≥—Ä–∞—Ü–∏–∏

- ‚úÖ `0001_initial.py` - —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
- ‚úÖ `0002_remove_store_books_book_stores.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã ManyToMany

### 3. –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

```bash
python manage.py migrate books
```

---

## üìä –û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –∏ —Å–≤—è–∑–µ–π

### –ú–æ–¥–µ–ª—å Publisher

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ –ø—É–±–ª–∏–∫—É–µ—Ç –∫–Ω–∏–≥–∏.

**–ü–æ–ª—è:**
- `name` - –ù–∞–∑–≤–∞–Ω–∏–µ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞ (CharField, max_length=200)
- `country` - –°—Ç—Ä–∞–Ω–∞ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞ (CharField, max_length=100)

**–°–≤—è–∑–∏:**
- –û–¥–∏–Ω –∫–æ –º–Ω–æ–≥–∏–º —Å Book: –æ–¥–Ω–æ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ –º–æ–∂–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–Ω–∏–≥
- –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å: `publisher.books.all()` - –≤—Å–µ –∫–Ω–∏–≥–∏ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞

### –ú–æ–¥–µ–ª—å Store

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∫–Ω–∏–∂–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω, –≥–¥–µ –ø—Ä–æ–¥–∞—é—Ç—Å—è –∫–Ω–∏–≥–∏.

**–ü–æ–ª—è:**
- `name` - –ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ (CharField, max_length=200)
- `city` - –ì–æ—Ä–æ–¥, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –º–∞–≥–∞–∑–∏–Ω (CharField, max_length=100)

**–°–≤—è–∑–∏:**
- –ú–Ω–æ–≥–∏–µ –∫–æ –º–Ω–æ–≥–∏–º —Å Book: –æ–¥–∏–Ω –º–∞–≥–∞–∑–∏–Ω –º–æ–∂–µ—Ç –ø—Ä–æ–¥–∞–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–Ω–∏–≥, –∏ –æ–¥–Ω–∞ –∫–Ω–∏–≥–∞ –º–æ–∂–µ—Ç –ø—Ä–æ–¥–∞–≤–∞—Ç—å—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–∞–≥–∞–∑–∏–Ω–∞—Ö
- –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å: `store.books.all()` - –≤—Å–µ –∫–Ω–∏–≥–∏ –≤ –º–∞–≥–∞–∑–∏–Ω–µ

### –ú–æ–¥–µ–ª—å Book

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∫–Ω–∏–≥—É —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –∞–≤—Ç–æ—Ä–µ, –¥–∞—Ç–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏–∏.

**–ü–æ–ª—è:**
- `title` - –ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ (CharField, max_length=200)
- `author` - –ê–≤—Ç–æ—Ä –∫–Ω–∏–≥–∏ (CharField, max_length=100)
- `published_date` - –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (DateField)
- `description` - –û–ø–∏—Å–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ (TextField)
- `publisher` - –ò–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ (ForeignKey –Ω–∞ Publisher)
- `stores` - –ú–∞–≥–∞–∑–∏–Ω—ã, –≥–¥–µ –ø—Ä–æ–¥–∞—ë—Ç—Å—è –∫–Ω–∏–≥–∞ (ManyToManyField –Ω–∞ Store)

**–°–≤—è–∑–∏:**
- ForeignKey –Ω–∞ Publisher: –∫–Ω–∏–≥–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞ –æ–¥–Ω–∏–º –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º
- ManyToManyField —Å Store: –∫–Ω–∏–≥–∞ –º–æ–∂–µ—Ç –ø—Ä–æ–¥–∞–≤–∞—Ç—å—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–∞–≥–∞–∑–∏–Ω–∞—Ö
- –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å: `book.reviews.all()` - –≤—Å–µ –æ—Ç–∑—ã–≤—ã –Ω–∞ –∫–Ω–∏–≥—É

### –ú–æ–¥–µ–ª—å Review

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –æ—Ç–∑—ã–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –∫–Ω–∏–≥—É —Å –æ—Ü–µ–Ω–∫–æ–π –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º.

**–ü–æ–ª—è:**
- `book` - –ö–Ω–∏–≥–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –æ—Å—Ç–∞–≤–ª–µ–Ω –æ—Ç–∑—ã–≤ (ForeignKey –Ω–∞ Book)
- `rating` - –û—Ü–µ–Ω–∫–∞ –∫–Ω–∏–≥–∏ –æ—Ç 1 –¥–æ 5 (IntegerField —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π)
- `text` - –¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞ (TextField)
- `created_at` - –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–∑—ã–≤–∞ (DateTimeField, auto_now_add=True)

**–°–≤—è–∑–∏:**
- ForeignKey –Ω–∞ Book: –æ—Ç–∑—ã–≤ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –æ–¥–Ω–æ–π –∫–Ω–∏–≥–µ
- –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å: `book.reviews.all()` - –≤—Å–µ –æ—Ç–∑—ã–≤—ã –Ω–∞ –∫–Ω–∏–≥—É

---

## üìù –ü–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### –ß–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—É—é –ø–∞–Ω–µ–ª—å Django

1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:**
   ```bash
   python manage.py runserver
   ```

2. **–û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å:**
   - URL: http://127.0.0.1:8000/admin/
   - –í–æ–π–¥–∏—Ç–µ —Å —É—á—ë—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

3. **–°–æ–∑–¥–∞–π—Ç–µ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞ (Publisher):**
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–ò–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞"
   - –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ"
   - –°–æ–∑–¥–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤:
     - –ù–∞–∑–≤–∞–Ω–∏–µ: "–≠–∫—Å–º–æ", –°—Ç—Ä–∞–Ω–∞: "–†–æ—Å—Å–∏—è"
     - –ù–∞–∑–≤–∞–Ω–∏–µ: "–ê–°–¢", –°—Ç—Ä–∞–Ω–∞: "–†–æ—Å—Å–∏—è"
     - –ù–∞–∑–≤–∞–Ω–∏–µ: "Penguin", –°—Ç—Ä–∞–Ω–∞: "–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è"

4. **–°–æ–∑–¥–∞–π—Ç–µ –º–∞–≥–∞–∑–∏–Ω—ã (Store):**
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–ú–∞–≥–∞–∑–∏–Ω—ã"
   - –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω"
   - –°–æ–∑–¥–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∞–≥–∞–∑–∏–Ω–æ–≤:
     - –ù–∞–∑–≤–∞–Ω–∏–µ: "–ß–∏—Ç–∞–π-–≥–æ—Ä–æ–¥", –ì–æ—Ä–æ–¥: "–ú–æ—Å–∫–≤–∞"
     - –ù–∞–∑–≤–∞–Ω–∏–µ: "–ë—É–∫–≤–æ–µ–¥", –ì–æ—Ä–æ–¥: "–ú–æ—Å–∫–≤–∞"
     - –ù–∞–∑–≤–∞–Ω–∏–µ: "–õ–∞–±–∏—Ä–∏–Ω—Ç", –ì–æ—Ä–æ–¥: "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥"

5. **–°–æ–∑–¥–∞–π—Ç–µ –∫–Ω–∏–≥–∏ (Book):**
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–ö–Ω–∏–≥–∏"
   - –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É"
   - –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è:
     - –ù–∞–∑–≤–∞–Ω–∏–µ: "–í–æ–π–Ω–∞ –∏ –º–∏—Ä"
     - –ê–≤—Ç–æ—Ä: "–õ–µ–≤ –¢–æ–ª—Å—Ç–æ–π"
     - –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: 1869-01-01
     - –û–ø–∏—Å–∞–Ω–∏–µ: "–†–æ–º–∞–Ω-—ç–ø–æ–ø–µ—è –õ—å–≤–∞ –¢–æ–ª—Å—Ç–æ–≥–æ"
     - –ò–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ: –≤—ã–±–µ—Ä–∏—Ç–µ "–≠–∫—Å–º–æ"
     - –ú–∞–≥–∞–∑–∏–Ω—ã: –≤—ã–±–µ—Ä–∏—Ç–µ "–ß–∏—Ç–∞–π-–≥–æ—Ä–æ–¥" –∏ "–ë—É–∫–≤–æ–µ–¥"
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–Ω–∏–≥—É
   - –°–æ–∑–¥–∞–π—Ç–µ –µ—â—ë –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–Ω–∏–≥ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º –æ–±—Ä–∞–∑–æ–º

6. **–°–æ–∑–¥–∞–π—Ç–µ –æ—Ç–∑—ã–≤—ã (Review):**
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–û—Ç–∑—ã–≤—ã"
   - –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤"
   - –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è:
     - –ö–Ω–∏–≥–∞: –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ–∑–¥–∞–Ω–Ω—É—é –∫–Ω–∏–≥—É
     - –û—Ü–µ–Ω–∫–∞: –≤—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç 1 –¥–æ 5
     - –¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞: –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –æ—Ç–∑—ã–≤
   - –°–æ–∑–¥–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ç–∑—ã–≤–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–Ω–∏–≥

### –ß–µ—Ä–µ–∑ Django Shell

```python
python manage.py shell

from books.models import Publisher, Store, Book, Review
from datetime import date

# –°–æ–∑–¥–∞–Ω–∏–µ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤
publisher1 = Publisher.objects.create(name='–≠–∫—Å–º–æ', country='–†–æ—Å—Å–∏—è')
publisher2 = Publisher.objects.create(name='–ê–°–¢', country='–†–æ—Å—Å–∏—è')
publisher3 = Publisher.objects.create(name='Penguin', country='–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è')

# –°–æ–∑–¥–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–æ–≤
store1 = Store.objects.create(name='–ß–∏—Ç–∞–π-–≥–æ—Ä–æ–¥', city='–ú–æ—Å–∫–≤–∞')
store2 = Store.objects.create(name='–ë—É–∫–≤–æ–µ–¥', city='–ú–æ—Å–∫–≤–∞')
store3 = Store.objects.create(name='–õ–∞–±–∏—Ä–∏–Ω—Ç', city='–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥')

# –°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–∏–≥
book1 = Book.objects.create(
    title='–í–æ–π–Ω–∞ –∏ –º–∏—Ä',
    author='–õ–µ–≤ –¢–æ–ª—Å—Ç–æ–π',
    published_date=date(1869, 1, 1),
    description='–†–æ–º–∞–Ω-—ç–ø–æ–ø–µ—è –õ—å–≤–∞ –¢–æ–ª—Å—Ç–æ–≥–æ',
    publisher=publisher1
)
book1.stores.add(store1, store2)

book2 = Book.objects.create(
    title='–ü—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∏ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ',
    author='–§—ë–¥–æ—Ä –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π',
    published_date=date(1866, 1, 1),
    description='–†–æ–º–∞–Ω –§—ë–¥–æ—Ä–∞ –î–æ—Å—Ç–æ–µ–≤—Å–∫–æ–≥–æ',
    publisher=publisher2
)
book2.stores.add(store1, store3)

book3 = Book.objects.create(
    title='1984',
    author='–î–∂–æ—Ä–¥–∂ –û—Ä—É—ç–ª–ª',
    published_date=date(1949, 6, 8),
    description='–†–æ–º–∞–Ω-–∞–Ω—Ç–∏—É—Ç–æ–ø–∏—è',
    publisher=publisher3
)
book3.stores.add(store2, store3)

# –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–æ–≤
Review.objects.create(book=book1, rating=5, text='–û—Ç–ª–∏—á–Ω–∞—è –∫–Ω–∏–≥–∞! –û—á–µ–Ω—å —Ä–µ–∫–æ–º–µ–Ω–¥—É—é.')
Review.objects.create(book=book1, rating=4, text='–û—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –Ω–æ –¥–ª–∏–Ω–Ω–æ–≤–∞—Ç–æ.')
Review.objects.create(book=book2, rating=5, text='–ö–ª–∞—Å—Å–∏–∫–∞! –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∫ –ø—Ä–æ—á—Ç–µ–Ω–∏—é.')
Review.objects.create(book=book2, rating=5, text='–ü–æ—Ç—Ä—è—Å–∞—é—â–µ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ!')
Review.objects.create(book=book3, rating=5, text='–ê–∫—Ç—É–∞–ª—å–Ω–æ –∏ –ø–æ —Å–µ–π –¥–µ–Ω—å.')
Review.objects.create(book=book3, rating=4, text='–ò–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è –∞–Ω—Ç–∏—É—Ç–æ–ø–∏—è.')
```

---

## üîç –û–ø–∏—Å–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –ó–∞–ø—Ä–æ—Å 1: –ö–Ω–∏–≥–∏ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤ –∏–∑ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã

**–õ–æ–≥–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ ForeignKey: `publisher__country`
- Django ORM –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç JOIN –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏ Book –∏ Publisher
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –∫–Ω–∏–≥–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–µ

**SQL-—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç:**
```sql
SELECT * FROM books_book 
INNER JOIN books_publisher ON books_book.publisher_id = books_publisher.id 
WHERE books_publisher.country = '–†–æ—Å—Å–∏—è';
```

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
from books.queries import get_books_by_publisher_country

books = get_books_by_publisher_country('–†–æ—Å—Å–∏—è')
for book in books:
    print(f"{book.title} - {book.publisher.name}")
```

### –ó–∞–ø—Ä–æ—Å 2: –ö–Ω–∏–≥–∏, –ø—Ä–æ–¥–∞—é—â–∏–µ—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω–∞—Ö –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞

**–õ–æ–≥–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ ManyToManyField: `stores__city`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `distinct()` –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–∫–Ω–∏–≥–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–∞–≥–∞–∑–∏–Ω–∞—Ö –æ–¥–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞)
- Django ORM –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç JOIN —á–µ—Ä–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—É—é —Ç–∞–±–ª–∏—Ü—É ManyToMany

**SQL-—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç:**
```sql
SELECT DISTINCT books_book.* FROM books_book 
INNER JOIN books_book_stores ON books_book.id = books_book_stores.book_id 
INNER JOIN books_store ON books_book_stores.store_id = books_store.id 
WHERE books_store.city = '–ú–æ—Å–∫–≤–∞';
```

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
from books.queries import get_books_by_store_city

books = get_books_by_store_city('–ú–æ—Å–∫–≤–∞')
for book in books:
    print(f"{book.title} –ø—Ä–æ–¥–∞—ë—Ç—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω–∞—Ö –ú–æ—Å–∫–≤—ã")
```

### –ó–∞–ø—Ä–æ—Å 3: –ö–Ω–∏–≥–∏ —Å–æ —Å—Ä–µ–¥–Ω–µ–π –æ—Ü–µ–Ω–∫–æ–π –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞

**–õ–æ–≥–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é `Avg('reviews__rating')` –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–π –æ—Ü–µ–Ω–∫–∏
- –§–∏–ª—å—Ç—Ä—É–µ—Ç –∫–Ω–∏–≥–∏ –ø–æ –ø–æ—Ä–æ–≥–æ–≤–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é: `avg_rating__gt=rating_threshold`
- Django ORM –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –≤—ã—á–∏—Å–ª—è–µ—Ç —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

**SQL-—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç:**
```sql
SELECT books_book.*, AVG(books_review.rating) AS avg_rating 
FROM books_book 
LEFT OUTER JOIN books_review ON books_book.id = books_review.book_id 
GROUP BY books_book.id 
HAVING AVG(books_review.rating) > 4.5;
```

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
from books.queries import get_books_with_avg_rating_above

books = get_books_with_avg_rating_above(4.5)
for book in books:
    print(f"{book.title} - –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: {book.avg_rating:.2f}")
```

### –ó–∞–ø—Ä–æ—Å 4: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥ –≤ –∫–∞–∂–¥–æ–º –º–∞–≥–∞–∑–∏–Ω–µ

**–õ–æ–≥–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é `Count('books')` –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–Ω–∏–≥
- –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –º–∞–≥–∞–∑–∏–Ω—ã –ø–æ —É–±—ã–≤–∞–Ω–∏—é –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–Ω–∏–≥: `order_by('-books_count')`
- Django ORM –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –ø–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ

**SQL-—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç:**
```sql
SELECT books_store.*, COUNT(books_book_stores.book_id) AS books_count 
FROM books_store 
LEFT OUTER JOIN books_book_stores ON books_store.id = books_book_stores.store_id 
GROUP BY books_store.id 
ORDER BY books_count DESC;
```

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
from books.queries import get_store_books_count

stores = get_store_books_count()
for store in stores:
    print(f"{store.name} ({store.city}): {store.books_count} –∫–Ω–∏–≥")
```

### –ó–∞–ø—Ä–æ—Å 5: –ú–∞–≥–∞–∑–∏–Ω—ã —Å –∫–Ω–∏–≥–∞–º–∏, –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ—Å–ª–µ –¥–∞—Ç—ã

**–õ–æ–≥–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:**
- –§–∏–ª—å—Ç—Ä—É–µ—Ç –º–∞–≥–∞–∑–∏–Ω—ã –ø–æ –¥–∞—Ç–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∫–Ω–∏–≥: `books__published_date__gt=date`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é `Count('books')` –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–Ω–∏–≥
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `distinct()` –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –º–∞–≥–∞–∑–∏–Ω—ã –ø–æ —É–±—ã–≤–∞–Ω–∏—é –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–Ω–∏–≥

**SQL-—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç:**
```sql
SELECT DISTINCT books_store.*, COUNT(books_book_stores.book_id) AS books_count 
FROM books_store 
INNER JOIN books_book_stores ON books_store.id = books_book_stores.store_id 
INNER JOIN books_book ON books_book_stores.book_id = books_book.id 
WHERE books_book.published_date > '2010-01-01' 
GROUP BY books_store.id 
ORDER BY books_count DESC;
```

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
from books.queries import get_stores_with_books_after_date
from datetime import date

stores = get_stores_with_books_after_date(date(2010, 1, 1))
for store in stores:
    print(f"{store.name} ({store.city}): {store.books_count} –∫–Ω–∏–≥")
```

---

## ‚ö° –ü–æ—è—Å–Ω–µ–Ω–∏—è –∫ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

### select_related() –¥–ª—è ForeignKey

**–ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
–ü—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ —Å–≤—è–∑–∞–Ω–Ω–æ–º—É –æ–±—ä–µ–∫—Ç—É —á–µ—Ä–µ–∑ ForeignKey Django –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏ (–ø—Ä–æ–±–ª–µ–º–∞ N+1 –∑–∞–ø—Ä–æ—Å–æ–≤).

**–ü—Ä–∏–º–µ—Ä –±–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```python
books = Book.objects.all()  # 1 –∑–∞–ø—Ä–æ—Å
for book in books:
    print(book.publisher.name)  # N –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ –∫–∞–∂–¥—É—é –∫–Ω–∏–≥—É)
# –ò—Ç–æ–≥–æ: 1 + N –∑–∞–ø—Ä–æ—Å–æ–≤
```

**–†–µ—à–µ–Ω–∏–µ —Å select_related():**
```python
books = Book.objects.select_related('publisher').all()  # 1 –∑–∞–ø—Ä–æ—Å —Å JOIN
for book in books:
    print(book.publisher.name)  # 0 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
# –ò—Ç–æ–≥–æ: 1 –∑–∞–ø—Ä–æ—Å
```

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- `select_related()` –≤—ã–ø–æ–ª–Ω—è–µ—Ç SQL JOIN –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏ Book –∏ Publisher
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
- Django –∫—ç—à–∏—Ä—É–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –≤ –ø–∞–º—è—Ç–∏

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –î–ª—è ForeignKey (–æ–¥–∏–Ω –∫–æ –º–Ω–æ–≥–∏–º)
- –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
- –ö–æ–≥–¥–∞ –∏–∑–≤–µ—Å—Ç–Ω–æ, —á—Ç–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Å–≤—è–∑–∞–Ω–Ω–æ–º—É –æ–±—ä–µ–∫—Ç—É

### prefetch_related() –¥–ª—è ManyToMany

**–ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
–ü—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ —Å–≤—è–∑–∞–Ω–Ω—ã–º –æ–±—ä–µ–∫—Ç–∞–º —á–µ—Ä–µ–∑ ManyToManyField Django –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏.

**–ü—Ä–∏–º–µ—Ä –±–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```python
books = Book.objects.all()  # 1 –∑–∞–ø—Ä–æ—Å
for book in books:
    stores = list(book.stores.all())  # N –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ –∫–∞–∂–¥—É—é –∫–Ω–∏–≥—É)
# –ò—Ç–æ–≥–æ: 1 + N –∑–∞–ø—Ä–æ—Å–æ–≤
```

**–†–µ—à–µ–Ω–∏–µ —Å prefetch_related():**
```python
books = Book.objects.prefetch_related('stores').all()  # 2 –∑–∞–ø—Ä–æ—Å–∞
for book in books:
    stores = list(book.stores.all())  # 0 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
# –ò—Ç–æ–≥–æ: 2 –∑–∞–ø—Ä–æ—Å–∞ (1 –¥–ª—è –∫–Ω–∏–≥ + 1 –¥–ª—è –≤—Å–µ—Ö —Å–≤—è–∑–µ–π)
```

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- `prefetch_related()` –≤—ã–ø–æ–ª–Ω—è–µ—Ç 2 –∑–∞–ø—Ä–æ—Å–∞:
  1. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –∫–Ω–∏–≥
  2. –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —Å–≤—è–∑–µ–π ManyToMany
- Django –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç —Å–≤—è–∑–∏ –ø–æ –æ–±—ä–µ–∫—Ç–∞–º –≤ –ø–∞–º—è—Ç–∏
- –ü—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ —Å–≤—è–∑–∞–Ω–Ω—ã–º –æ–±—ä–µ–∫—Ç–∞–º –¥–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ –∫—ç—à–∞

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –î–ª—è ManyToManyField
- –î–ª—è –æ–±—Ä–∞—Ç–Ω—ã—Ö —Å–≤—è–∑–µ–π ForeignKey (related_name)
- –ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤

### –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ select_related() –∏ prefetch_related()

**–ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
```python
books = Book.objects.select_related('publisher').prefetch_related(
    'stores',
    'reviews'
).all()

for book in books:
    print(book.publisher.name)  # –î–∞–Ω–Ω—ã–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    stores = list(book.stores.all())  # –î–∞–Ω–Ω—ã–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    reviews = list(book.reviews.all())  # –î–∞–Ω–Ω—ã–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- 1 –∑–∞–ø—Ä–æ—Å –¥–ª—è –∫–Ω–∏–≥ —Å JOIN –∫ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞–º
- 1 –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—Å–µ—Ö —Å–≤—è–∑–µ–π ManyToMany —Å –º–∞–≥–∞–∑–∏–Ω–∞–º–∏
- 1 –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—Å–µ—Ö –æ—Ç–∑—ã–≤–æ–≤
- **–ò—Ç–æ–≥–æ: 3 –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–Ω–∏–≥**

**–ë–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –±—ã–ª–æ –±—ã:**
- 1 –∑–∞–ø—Ä–æ—Å –¥–ª—è –∫–Ω–∏–≥
- N –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤
- N –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–æ–≤
- N –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤
- **–ò—Ç–æ–≥–æ: 1 + 3N –∑–∞–ø—Ä–æ—Å–æ–≤**

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π

### –ó–∞–¥–∞–Ω–∏–µ 1: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–æ–¥–µ–ª—å Publisher
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–æ–¥–µ–ª—å Store
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–æ–¥–µ–ª—å Review
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–æ–¥–µ–ª—å Book —Å —Å–≤—è–∑—è–º–∏
- ‚úÖ –í—Å–µ –º–æ–¥–µ–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

### –ó–∞–¥–∞–Ω–∏–µ 2: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ó–∞–ø—Ä–æ—Å 1: –ö–Ω–∏–≥–∏ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤ –∏–∑ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã
- ‚úÖ –ó–∞–ø—Ä–æ—Å 2: –ö–Ω–∏–≥–∏, –ø—Ä–æ–¥–∞—é—â–∏–µ—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω–∞—Ö –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞
- ‚úÖ –ó–∞–ø—Ä–æ—Å 3: –ö–Ω–∏–≥–∏ —Å–æ —Å—Ä–µ–¥–Ω–µ–π –æ—Ü–µ–Ω–∫–æ–π –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞
- ‚úÖ –ó–∞–ø—Ä–æ—Å 4: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥ –≤ –∫–∞–∂–¥–æ–º –º–∞–≥–∞–∑–∏–Ω–µ
- ‚úÖ –ó–∞–ø—Ä–æ—Å 5: –ú–∞–≥–∞–∑–∏–Ω—ã —Å –∫–Ω–∏–≥–∞–º–∏ –ø–æ—Å–ª–µ –¥–∞—Ç—ã, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É

### –ó–∞–¥–∞–Ω–∏–µ 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ select_related() –¥–ª—è ForeignKey
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ prefetch_related() –¥–ª—è ManyToMany
- ‚úÖ –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

- `books/README.md` - –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- `books/queries.py` - –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
- `–ê–ù–ê–õ–ò–ó_–ò–ù–¢–ï–ì–†–ê–¶–ò–ò_–¢–ï–ú–ê_20.md` - –ê–Ω–∞–ª–∏–∑ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –ø—Ä–æ–µ–∫—Ç–æ–º

---

**–î–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**: 2025-01-27  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–°–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –í–´–ü–û–õ–ù–ï–ù–´

